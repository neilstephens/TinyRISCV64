name: Build and Test

on:
  push:
  pull_request:

jobs:
  build:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------- STP TEST --------
      - name: Configure STP
        run: |
          cmake -S Test/STP -B build_stp -DCMAKE_BUILD_TYPE=Release

      - name: Build STP
        run: |
          cmake --build build_stp --config Release

      - name: Run STP
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            ./build_stp/Release/rv64im_stp_runner.exe Test/STP/Claude/rv64im_stp.s Test/STP/Claude/rv64im_stp.bin
          else
            ./build_stp/rv64im_stp_runner Test/STP/Claude/rv64im_stp.s Test/STP/Claude/rv64im_stp.bin
          fi

      # -------- STRESS TEST --------
      - name: Configure stress
        run: |
          cmake -S Test/stress -B build_stress -DCMAKE_BUILD_TYPE=Release

      - name: Build stress
        run: |
          cmake --build build_stress --config Release

      - name: Run stress
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            ./build_stress/Release/stress.exe Test/stress/stress.rv64im
          else
            ./build_stress/stress Test/stress/stress.rv64im
          fi
